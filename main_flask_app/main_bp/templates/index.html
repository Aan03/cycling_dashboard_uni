{% extends 'layout.html' %}
{% set title = 'Cycling Map' %}
{% block content %}
<head>
  <title>leaflet-map-csv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Load Leaflet code library - see updates at http://leafletjs.com/download.html-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        
  <!-- Load jQuery and PapaParse to read data from a CSV file -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <!--https://handsondataviz.org/leaflet-maps-with-csv.html-->

  <!-- Position the map with Cascading Style Sheet (CSS) -->
  <!--
  #body { margin:"50%"; padding:0; }
  
    -->
  <style>
  #map {position: absolute; border: 2px solid #44532e;
        height: 90vh; width: 50vw;}  

  #map_side_options {position: absolute;
        right:0; 
        height: 90vh; width: 40vw;}

  </style>
  
</head>

  <!-- Insert HTML division tag to layout the map -->
  <div id="map"></div>
  
  
  <div id="map_side_options">
  <p>filters and add reports?</p>

  <div id="checking">
  <input type="checkbox" id="covered_box" name="covered">
  <label for="covered_box">Covered</label><br>
  <input type="checkbox" id="secured_box" name="secured">
  <label for="covered_box">Secured</label><br>
  <input type="checkbox" id="locker_box" name="locker">
  <label for="covered_box">Locker</label><br>

  <br>

  <select name="borough_select" id="borough_select">
    {% for borough in boroughs %}
        <option value="{{borough}}">{{borough}}</option>"
    {% endfor %}
  </select>

  </div>
  

  {% if current_user.is_authenticated %}

  <h1>"Logged in"</h1>

  <div class='message'>
    <h3>{{ messages['title'] }}</h3>
    <h3>{{ messages['date'] }}</h3>
    <h3>{{ messages['time'] }}</h3>
    <p>{{ messages['content'] }}</p>
  
    <h1>"Report Form"</h1>
  <form method="post">
    <label for="title">Rack ID</label>
    <br>
    <input type="text" name="title" id="rack_id_input"
           placeholder="Rack ID"
           value="{{ request.form['title'] }}"></input>
    <br>

    <label for="title">Date</label>
    <br>
    <input type="text" name="date" id="date_input"
           placeholder="Date"
           value="{{ request.form['date'] }}"></input>
    <br>

    <label for="title">Time</label>
    <br>
    <input type="text" name="time" id="time_input"
           placeholder="Time"
           value="{{ request.form['time'] }}"></input>
    <br>

    <label for="content">Report Details</label>
    <br>
    <textarea name="content"
              placeholder="Message content"
              rows="15"
              cols="60"
              >{{ request.form['content'] }}</textarea>
    <br>
    <button type="submit">Submit</button>
  </form>

  {% endif %}

  {% if not current_user.is_authenticated %}
  <h1>"Not logged in"</h1>
  {% endif %}

  </div>
  
  <!-- Insert Javascript (.js) code to create the map -->
  <script>

  // Set up initial map center and zoom level
  var map = L.map('map', {
    preferCanvas: true, //added to decrease speed
    center: [51.51, -0.1], // EDIT latitude, longitude to re-center map
    zoom: 10,  // EDIT from 1 to 18 -- decrease to zoom out, increase to zoom in
    scrollWheelZoom: true,
    tap: false
  });

  /* Control panel to display map layers 
  var controlLayers = L.control.layers( null, null, {
    position: "topright",
    collapsed: false
  }).addTo(map);
  */

  // display Carto basemap tiles with light features and labels
  var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
  }).addTo(map); // EDIT - insert or remove ".addTo(map)" before last semicolon to display by default
  //controlLayers.addBaseLayer(light, 'Carto Light basemap');

  // see more basemap options at https://leaflet-extras.github.io/leaflet-providers/preview/

  const markers = JSON.parse('{{ markers | safe }}');
  const markers_info = JSON.parse('{{ markers_info | safe }}');
  const covered_cbox = document.getElementById('covered_box');
  const secured_cbox = document.getElementById('secured_box');
  const locker_cbox = document.getElementById('locker_box');

  const borough_dd = document.getElementById("borough_select");


  borough_dd.addEventListener("change", recheck_boxes)

  function recheck_boxes(){
    map.removeLayer(all_markers);
    $('#covered_box').prop('checked', false);
    $('#secured_box').prop('checked', false);
    $('#locker_box').prop('checked', false);
    covered_cbox.addEventListener('change', covered_check);
    secured_cbox.addEventListener('change', secured_check);
    locker_cbox.addEventListener('change', locker_check);

  }
  function check_false_checked(){
    if (covered_cbox.checked == false && secured_cbox.checked == false && locker_cbox.checked == false){
    map.addLayer(all_markers)
  }}


  function check__if_checked(cbox, temp_lyr_group, borough_dd_val, 
  marker_type){
    if (cbox.checked == true) {
    map.removeLayer(all_markers)
    console.log("ticked")
    if (borough_dd_val == "All Boroughs"){
      var temp_lyr_group = marker_type
      map.addLayer(temp_lyr_group)  
      }
    else {
    map.addLayer(temp_lyr_group)
      }
  } else {
    map.removeLayer(temp_lyr_group)
  }
  }

  covered_cbox.addEventListener('change', covered_check)

  function covered_check() {
    check_false_checked()
    var temp_lyr_group_c = L.featureGroup()
    var borough_dd_val = borough_dd.value
    markers_locker.eachLayer(function(layer) {
      if (borough_dd_val == layer.myJsonData.BOROUGH){
        layer.addTo(temp_lyr_group_c);    
      }
    });
    check__if_checked(covered_cbox, temp_lyr_group_c, borough_dd_val, markers_covered)
  };

  secured_cbox.addEventListener('change', secured_check)

  function secured_check() {
    check_false_checked()
    var temp_lyr_group_s = L.featureGroup()
    var borough_dd_val = borough_dd.value
    markers_locker.eachLayer(function(layer) {
      if (borough_dd_val == layer.myJsonData.BOROUGH){
        layer.addTo(temp_lyr_group_s);    
      }
    });
    check__if_checked(secured_cbox, temp_lyr_group_s, borough_dd_val, markers_secured)
  };

  /*locker_cbox.addEventListener('change', locker_check)

  function locker_check() {
    check_false_checked()
    var temp_lyr_group_l = L.featureGroup()
    var borough_dd_val = borough_dd.value
    markers_locker.eachLayer(function(layer) {
      if (borough_dd_val == layer.myJsonData.BOROUGH){
        layer.addTo(temp_lyr_group_l);    
      }
    });
    check__if_checked(locker_cbox, temp_lyr_group_l, borough_dd_val, markers_locker)
  };
  */
  var all_markers = L.featureGroup();
  var markers_covered = L.featureGroup();
  var markers_secured = L.featureGroup();
  var markers_locker = L.featureGroup();
  for(var i in markers){
    var marker_lat = markers[i].Latitude;
    var marker_long = markers[i].Longitude;
    var radius = 4; // set the radius of the marker to 1 pixel
    var marker_new = L.circleMarker([marker_lat, marker_long], {
      radius: radius,
      stroke: true, // show the outline of the marker
      weight: 1, // set the thickness of the outline
      color: 'green', // set the color of the outline
      fill: false, // do not fill the marker
      fillOpacity: 0, // set the opacity of the fill to 0
     // bubblingMouseEvents: false
    })

    marker_new.myJsonData = markers_info[i]
    var marker_title = marker_new.myJsonData.Title;
    var marker_photo1 = marker_new.myJsonData.PHOTO1_URL;
    var marker_photo2 = marker_new.myJsonData.PHOTO2_URL;
    var borough_marker = marker_new.myJsonData.BOROUGH
    var capacity_marker = marker_new.myJsonData.PRK_CPT
    var secured_marker = marker_new.myJsonData.PRK_SECURE
    var locker_marker = marker_new.myJsonData.PRK_LOCKER
    var covered_marker = marker_new.myJsonData.PRK_COVER

    
    marker_new.bindPopup();
    marker_new.on('popupopen', function(e) {
    var marker_new = e.target
    var marker_title = marker_new.myJsonData.Title;
    var marker_photo1 = marker_new.myJsonData.PHOTO1_URL;
    var marker_photo2 = marker_new.myJsonData.PHOTO2_URL;
    var borough_marker = marker_new.myJsonData.BOROUGH
    var capacity_marker = marker_new.myJsonData.PRK_CPT
    var secured_marker = marker_new.myJsonData.PRK_SECURE
    var locker_marker = marker_new.myJsonData.PRK_LOCKER
    var covered_marker = marker_new.myJsonData.PRK_COVER

    var main_div = document.createElement("div")
    var main_div_img = document.createElement("div");
    var img = document.createElement('img');
    img.id = "marker_image"
    img.alt = "Image of bike rack"
    img.src = marker_photo1;
    img.style.width = "150px";
    img.style.height = "150px";
    main_div_img.appendChild(img);
    main_div.appendChild(main_div_img)

    var buttons_div = document.createElement("div");
    var button_one = document.createElement("BUTTON");
    button_one.id ='image_1_button';
    button_one.innerHTML = "Image One";
    var button_two = document.createElement("BUTTON");
    button_two.id ='image_2_button';
    button_two.innerHTML = "Image Two";
    buttons_div.appendChild(button_one)
    buttons_div.appendChild(button_two)
    main_div.appendChild(buttons_div)

    var info_div = document.createElement("div")
    borough_p = document.createElement("p")
    borough_p.innerHTML = "Borough: " + borough_marker
    info_div.appendChild(borough_p)
    capacity_p = document.createElement("p")
    capacity_p.innerHTML = "Capacity: " + capacity_marker
    info_div.appendChild(capacity_p)
    secured_p = document.createElement("p")  
    secured_p.innerHTML = "Secured: " + secured_marker
    info_div.appendChild(secured_p)
    covered_p = document.createElement("p") 
    covered_p.innerHTML = "Covered: " + covered_marker
    info_div.appendChild(covered_p)
    locker_p = document.createElement("p")
    locker_p.innerHTML = "Locker: " + locker_marker
    info_div.appendChild(locker_p)

    main_div.appendChild(info_div)

   marker_popup = e.popup; 
   marker_popup.setContent(main_div)
   function img1() {
      img.src = marker_photo1;
      marker_new.getPopup().setContent(main_div);
      button_one.addEventListener("click", img1)
      button_two.addEventListener("click", img2)
    }
   function img2() {
      img.src = marker_photo2;
      marker_new.getPopup().setContent(main_div);
      button_one.addEventListener("click", img1)
      button_two.addEventListener("click", img2)
    }
   
    button_one.addEventListener("click", img1)
    button_two.addEventListener("click", img2)
   });
    
    
    marker_new.addTo(all_markers);
    
    
    if (secured_marker == "True"){
      marker_new.addTo(markers_secured);
    }
    if (covered_marker == "True"){
      marker_new.addTo(markers_covered);
    }
    if (locker_marker == "True"){
      marker_new.addTo(markers_locker);
    }


    function report_fill(title) {
    var date = new Date();
    formatted_date = date.toLocaleDateString('en-GB', {
    year: 'numeric', month: '2-digit', day: '2-digit'})
    formatted_time = date.toLocaleTimeString('en-GB', {
    hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'})
    document.getElementById("rack_id_input").value=title;
    document.getElementById("date_input").value=formatted_date;
    document.getElementById("time_input").value=formatted_time;
    }

    
    function onMarkerClick(e) {
    console.log(this.options)
    var current_marker = e.target;
    var title = current_marker.myJsonData.FEATURE_ID;
    if ('{{current_user.is_authenticated}}' == "True") {
      report_fill(title)
      console.log("worked true")
    }
    
      /*
    function onMarkerClick(e) {
    var marker = e.target;
    var marker_title = marker.getPopup().getContent(); // get the title of the marker
    var report_text = prompt("Please enter your report for " + marker_title + ":"); // prompt the user to enter their report
    if (report_text != null && report_text != "") { // check if the user entered a report
      // send the report to the API
      var data = {
        marker_title: marker_title,
        report_text: report_text
      };
      fetch('/api/save-report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        // handle the response from the API
        console.log(response);
      })
      .catch(error => {
        // handle any errors that occur during the API call
        console.error(error);
      });
    }
  }
  */
    }
  }
  check_false_checked()
  
  
    

    
   

    
  
  //}

//}
  </script>
{% endblock %}