{% extends 'layout.html' %}
{% set title = 'Cycling Map' %}
{% block content %}
<head>
  <title>leaflet-map-csv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Load Leaflet code library - see updates at http://leafletjs.com/download.html-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        
  <!-- Load jQuery and PapaParse to read data from a CSV file 
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  https://handsondataviz.org/leaflet-maps-with-csv.html
-->
  <!-- Position the map with Cascading Style Sheet (CSS) -->
  <!--
  #body { margin:"50%"; padding:0; }
  
    -->
  <style>
    
    #map { position: absolute; top:10%; bottom:0; right:50%; left:0; }
    #test { position: absolute; top:10%; bottom:0; right:0; left:60%; }
  
  </style>
  

 
  
</head>

  <!-- Insert HTML division tag to layout the map -->
  <div id="map"></div>
  
  <div id="test">
  <p>filters and add reports?</p>

  {% if current_user.is_authenticated %}

  <h1>"Logged in"</h1>

  <div class='message'>
    <h3>{{ messages['title'] }}</h3>
    <h3>{{ messages['date'] }}</h3>
    <h3>{{ messages['time'] }}</h3>
    <p>{{ messages['content'] }}</p>
  
    <h1>"Report Form"</h1>
  <form method="post">
    <label for="title">Rack ID</label>
    <br>
    <input type="text" name="title" id="rack_id_input"
           placeholder="Rack ID"
           value="{{ request.form['title'] }}"></input>
    <br>

    <label for="title">Date</label>
    <br>
    <input type="text" name="date" id="date_input"
           placeholder="Date"
           value="{{ request.form['date'] }}"></input>
    <br>

    <label for="title">Time</label>
    <br>
    <input type="text" name="time" id="time_input"
           placeholder="Time"
           value="{{ request.form['time'] }}"></input>
    <br>

    <label for="content">Report Details</label>
    <br>
    <textarea name="content"
              placeholder="Message content"
              rows="15"
              cols="60"
              >{{ request.form['content'] }}</textarea>
    <br>
    <button type="submit">Submit</button>
  </form>

  {% endif %}

  {% if not current_user.is_authenticated %}
  <h1>"Not logged in"</h1>
  {% endif %}

  </div>
  <!-- Insert Javascript (.js) code to create the map -->
  <script>

  // Set up initial map center and zoom level
  var map = L.map('map', {
    preferCanvas: true, //added to decrease speed
    center: [51.51, -0.1], // EDIT latitude, longitude to re-center map
    zoom: 10,  // EDIT from 1 to 18 -- decrease to zoom out, increase to zoom in
    scrollWheelZoom: true,
    tap: false
  });

  /* Control panel to display map layers 
  var controlLayers = L.control.layers( null, null, {
    position: "topright",
    collapsed: false
  }).addTo(map);
  */

  // display Carto basemap tiles with light features and labels
  var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
  }).addTo(map); // EDIT - insert or remove ".addTo(map)" before last semicolon to display by default
  //controlLayers.addBaseLayer(light, 'Carto Light basemap');


  // see more basemap options at https://leaflet-extras.github.io/leaflet-providers/preview/

  
  const markers = JSON.parse('{{ markers | safe }}');
  const markers_info = JSON.parse('{{ markers_info | safe }}');
  

  for(var i in markers){
    var marker_lat = markers[i].Latitude;
    var marker_long = markers[i].Longitude;
    var radius = 4; // set the radius of the marker to 1 pixel
    var marker_new = L.circleMarker([marker_lat, marker_long], {
      radius: radius,
      stroke: true, // show the outline of the marker
      weight: 1, // set the thickness of the outline
      color: 'green', // set the color of the outline
      fill: false, // do not fill the marker
      fillOpacity: 0 // set the opacity of the fill to 0
    })

    marker_new.myJsonData = markers_info[i]
    var marker_title = marker_new.myJsonData.Title;
    var marker_photo1 = marker_new.myJsonData.PHOTO1_URL;
    var marker_photo2 = marker_new.myJsonData.PHOTO2_URL;
    var borough_marker = marker_new.myJsonData.BOROUGH
    var capacity_marker = marker_new.myJsonData.PRK_CPT
    var secured_marker = marker_new.myJsonData.PRK_SECURE
    var locker_marker = marker_new.myJsonData.PRK_LOCKER
    var covered_marker = marker_new.myJsonData.PRK_COVER

    for_image_one = 
      "<div><img src= " + marker_photo1 + " id= marker_image, alt=" + '"Image of bike rack"' + ", width= 150px, height= 150px></div>" +
      "<div><button id=" + "image_one" + ">Image One</button>" +
      "<button id=" + "image_two" + ">Image Two</button></div>" +
      "<div><p>" + "Borough: " + borough_marker + "</p>" +
      "<p>" + "Capacity: " + capacity_marker + "</p>" +
      "<p>" + "Secured: " + secured_marker + "</p>" +
      "<p>" + "Covered: " + covered_marker + "</p>" +
      "<p>" + "Locker: " + locker_marker + "</p></div>"
  
    marker_new.bindPopup(for_image_one);
    
    marker_new.addTo(map);
    
    marker_new.addEventListener("click", onMarkerClick)
    

    
    function onMarkerClick(e) {
    console.log(this.options)
    var date = new Date();
    var current_date = date.getFullYear()+"-"+(date.getMonth()+1)+"-"+ date.getDate();
    var current_time = date.getHours()+":"+date.getMinutes()+":"+ date.getSeconds();
    var current_marker = e.target;
    var title =current_marker.myJsonData.FEATURE_ID;
    console.log(title)
    document.getElementById("rack_id_input").value=title;
    document.getElementById("date_input").value=current_date;
    document.getElementById("time_input").value=current_time;
    var popup = current_marker.getPopup();


    var marker_photo1 = current_marker.myJsonData.PHOTO1_URL;
    var marker_photo2 = current_marker.myJsonData.PHOTO2_URL;
    var borough_marker = current_marker.myJsonData.BOROUGH
    var capacity_marker = current_marker.myJsonData.PRK_CPT
    var secured_marker = current_marker.myJsonData.PRK_SECURE
    var locker_marker = current_marker.myJsonData.PRK_LOCKER
    var covered_marker = current_marker.myJsonData.PRK_COVER
    
    image_one =
      "<div><img src= " + marker_photo1 + " id= marker_image, alt=" + '"Image of bike rack"' + ", width= 150px, height= 150px></div>"
      
    image_two = 
      "<div><img src= " + marker_photo2 + " id= marker_image, alt=" + '"Image of bike rack"' + ", width= 150px, height= 150px></div>"
      
    buttons_info =
      "<div><button id=" + "image_one" + ">Image One</button>" +
      "<button id=" + "image_two" + ">Image Two</button></div>" +
      "<div><p>" + "Borough: " + borough_marker + "</p>" +
      "<p>" + "Capacity: " + capacity_marker + "</p>" +
      "<p>" + "Secured: " + secured_marker + "</p>" +
      "<p>" + "Covered: " + covered_marker + "</p>" +
      "<p>" + "Locker: " + locker_marker + "</p></div>"

    for_image_one = (image_one + buttons_info)
    for_image_two = (image_two + buttons_info)

    console.log(marker_photo1, marker_photo2)
    console.log(current_marker.myJsonData)
  
    console.log(popup.isOpen())
    function img1() {
        popup.setContent(for_image_one)
        console.log("one clicked")
        document.getElementById('image_one').onclick = function() {img1()}
        document.getElementById('image_two').onclick = function() {img2()}

      }

    function img2() {
        popup.setContent(for_image_two)
        console.log("two clicked")
        document.getElementById('image_one').onclick = function() {img1()}
        document.getElementById('image_two').onclick = function() {img2()}
 
        
        
      }

    document.getElementById('image_one').onclick = function() {img1()}
    document.getElementById('image_two').onclick = function() {img2()}


    console.log(current_marker)


      /*
    function onMarkerClick(e) {
    var marker = e.target;
    var marker_title = marker.getPopup().getContent(); // get the title of the marker
    var report_text = prompt("Please enter your report for " + marker_title + ":"); // prompt the user to enter their report
    if (report_text != null && report_text != "") { // check if the user entered a report
      // send the report to the API
      var data = {
        marker_title: marker_title,
        report_text: report_text
      };
      fetch('/api/save-report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => {
        // handle the response from the API
        console.log(response);
      })
      .catch(error => {
        // handle any errors that occur during the API call
        console.error(error);
      });
    }
  }
  */
    }
  }
  
    

    
   

    
  
  //}

//}
  </script>
{% endblock %}